# 서브노트 버전 관리 시스템

## 개요
서브노트의 모든 수정 이력을 저장하고, 이전 버전으로 복구하거나 버전 간 차이를 비교할 수 있는 기능

## 데이터베이스 구조

### subnote_versions 테이블
```sql
subnote_versions (
  id: UUID (Primary Key)
  subnote_id: UUID (Foreign Key -> subnotes.id)
  version_number: INTEGER (버전 번호, 자동 증가)
  title: VARCHAR (해당 버전의 제목)
  keywords: TEXT[] (해당 버전의 키워드)
  content: JSONB/TEXT (해당 버전의 본문)
  category_id: UUID (해당 버전의 카테고리)
  change_summary: TEXT (수정 요약 - 선택사항)
  created_by: UUID (수정한 사용자)
  created_at: TIMESTAMP (버전 생성 시각)
)
```

### 인덱스
```sql
CREATE INDEX idx_subnote_versions_subnote_id ON subnote_versions(subnote_id);
CREATE INDEX idx_subnote_versions_created_at ON subnote_versions(created_at);
```

## 버전 생성 시점
1. **서브노트 최초 생성 시**
   - Version 1 자동 생성

2. **서브노트 수정 저장 시**
   - 새로운 버전 자동 생성
   - 버전 번호 자동 증가
   - 수정 요약 입력 (선택사항)

3. **저장 전략**
   - 매 저장마다 새 버전 생성
   - 또는 일정 시간 간격으로 버전 생성 (예: 1시간에 1번)
   - 권장: 매 저장마다 버전 생성 (스토리지는 저렴함)

## 주요 기능

### 1. 수정 이력 조회
- **이력 목록**
  - 버전 번호
  - 수정 일시
  - 수정한 사용자
  - 수정 요약
  - 파일 크기 변화

- **UI 예시**
  ```
  Version 5 - 2025-11-05 14:30 (현재)
  작성자: 김관리자
  요약: 예제 코드 추가

  Version 4 - 2025-11-05 10:15
  작성자: 김관리자
  요약: 오타 수정

  Version 3 - 2025-11-04 16:45
  작성자: 이강사
  요약: 내용 보강
  ```

### 2. 버전 비교 (Diff)
- **비교 뷰**
  - 두 버전 선택하여 비교
  - 변경 사항 시각화
  - 추가된 내용 (녹색)
  - 삭제된 내용 (빨간색)
  - 수정된 내용 (노란색)

- **비교 레벨**
  - 제목 변경
  - 키워드 변경
  - 카테고리 변경
  - 본문 내용 변경 (텍스트 diff)

### 3. 이전 버전 복구
- **복구 방식**
  - 특정 버전 선택
  - "이 버전으로 복구" 버튼
  - 확인 다이얼로그
  - 복구 시 새로운 버전 생성 (현재 → 이전)

- **복구 주의사항**
  - 복구는 새 버전을 만드는 것
  - 기존 버전은 삭제되지 않음
  - 언제든 다시 되돌릴 수 있음

### 4. 버전 미리보기
- 특정 버전 선택 시 읽기 전용으로 미리보기
- 현재 버전과 나란히 비교 (Side-by-side)

## UI/UX 구성

### 관리자 화면
1. **서브노트 편집 화면**
   - 우측 상단에 "수정 이력" 버튼
   - 클릭 시 사이드바 또는 모달 열림

2. **수정 이력 사이드바**
   - 버전 목록 (최신순)
   - 각 버전 클릭 시:
     - 미리보기
     - 복구
     - 비교

3. **버전 비교 화면**
   - Split view (좌: 이전 버전, 우: 현재 버전)
   - 또는 Unified view (하나의 화면에 diff 표시)
   - 변경 사항 하이라이트

### 수강생 화면
- 기본적으로 최신 버전만 표시
- 버전 이력은 보이지 않음 (관리자 전용)

## 추천 라이브러리

### Diff 기능
- `diff-match-patch` - 텍스트 비교 알고리즘
- `react-diff-viewer` - React diff 뷰어 컴포넌트
- `react-diff-view` - 코드 diff 뷰어
- `diff` - 간단한 diff 라이브러리

### 타임라인 UI
- `react-chrono` - 타임라인 컴포넌트
- `react-vertical-timeline-component` - 수직 타임라인

## 성능 최적화

### 1. 스토리지 최적화
- 전체 내용 저장 vs 변경 내용만 저장 (Delta)
- 권장: 전체 내용 저장 (조회 속도 빠름, Supabase 스토리지 저렴)

### 2. 조회 최적화
- 최근 N개 버전만 기본 로드
- "더 보기"로 이전 버전 로드 (Pagination)

### 3. 버전 보관 정책 (선택사항)
- 모든 버전 영구 보관
- 또는 일정 기간 이후 오래된 버전 삭제
- 권장: 모든 버전 영구 보관

## 구현 플로우

### 서브노트 저장 시
1. 현재 내용을 `subnote_versions`에 저장
2. `subnotes` 테이블의 메인 레코드 업데이트
3. 버전 번호 자동 증가

### 버전 복구 시
1. 선택한 버전의 내용 가져오기
2. 현재 내용을 새 버전으로 저장 (백업)
3. 선택한 버전 내용으로 메인 레코드 업데이트
4. 새 버전 번호 생성

## 추가 기능 (선택사항)

### 1. 변경 요약 자동 생성
- AI를 사용하여 변경 내용 자동 요약
- 예: "제목 변경, 3개 문단 추가, 1개 이미지 삽입"

### 2. 버전 태그
- 중요한 버전에 태그 달기
- 예: "v1.0 - 초안 완성", "v2.0 - 대대적 수정"

### 3. 협업 표시
- 여러 관리자가 수정하는 경우
- 누가 무엇을 수정했는지 명확히 표시
